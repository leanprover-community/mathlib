#!/usr/bin/env bash
set -ex
cd $(dirname "$(realpath "$0")")

header() {
  cat <<EOF
# DO NOT EDIT THIS FILE!!!

# This file is automatically generated by mk_build_yml.sh
# Edit build.yml.in instead and run mk_build_yml.sh to update.

EOF
}

build_yml() {
  header
  cat <<EOF
on:
  push:
    branches-ignore:
      # ignore tmp branches used by bors
      - 'staging.tmp*'
      - 'trying.tmp*'
      - 'staging*.tmp'
      - 'nolints'
      # do not build lean-x.y.z branch used by leanpkg
      - 'lean-3.*'
      # ignore staging branch used by bors, this is handled by bors.yml
      - 'staging'
EOF
  include 0 ubuntu-latest
}

bors_yml() {
  header
  cat <<EOF
on:
  push:
    branches:
      - staging
EOF
  include 1 self-hosted
}

include() {
  sed "
    s/IS_SELF_HOSTED/$1/g;
    s/RUNS_ON/$2/g;
  " build.yml.in
}

build_yml > build.yml
bors_yml > bors.yml
